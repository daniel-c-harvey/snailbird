@using SnailbirdAdminWeb.Client.API
@using SnailbirdAdminWeb.Client.ViewModels.EditFlex
@using SnailbirdData.Models.Post;
@using SnailbirdAdminWeb.Client.Models;
@using SnailbirdAdminWeb.Client.ViewModels;
@using SnailbirdAdminWeb.Client.Updates
@using SnailbirdMedia.Clients
@using RazorCore;

@typeparam TPost where TPost : FlexPost<TPost>, new()

<PostManager TPost="TPost" 
             TEdit="EditFlexPostViewModel<TPost>"
             TUpdate="FlexPostManagerUpdate<TPost>"
             ViewModel="@ViewModel">
    <AddComponent Context="viewModel">
        <EditFlexPost ViewModel="viewModel" />
    </AddComponent>
    <EditComponent Context="viewModel">
        <EditFlexPost ViewModel="viewModel" />
    </EditComponent>
</PostManager>

@code
{
    [Inject]
    public IServiceProvider? Services { get; set; }

    protected FlexPostManagerViewModel<TPost>? ViewModel { get; set; }

    protected override void OnInitialized()
    {
        base.OnInitialized();

        if (Services is null) throw new ArgumentNullException(nameof(Services));
        var postManagerClient = Services.GetService<IPostManagerClient<TPost>>();
        if (postManagerClient is null) throw new Exception(nameof(postManagerClient));
        var mediaClient = Services.GetService<IVaultManagerClient>();
        if (mediaClient is null) throw new ArgumentNullException(nameof(mediaClient));
        
        ViewModel = new FlexPostManagerViewModelFactory<TPost>(mediaClient).Create(postManagerClient);
        ViewModel.EditingViewModel = new EditFlexPostViewModel<TPost>(ViewModel.SavePost);
        ViewModel.AddViewModel = new EditFlexPostViewModel<TPost>(ViewModel.SaveNewPost);

    }
}